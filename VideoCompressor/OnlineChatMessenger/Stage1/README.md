# 満たすべき仕様
ステージ 1
推奨使用言語: Python（サーバとクライアント両方で）


内容
このステージでは、クライアントがサーバに接続する形式のチャットメッセンジャーサービスを作成します。サーバはバックグラウンドで稼働し、一方でクライアントは CLI を通じてサーバに接続します。接続が確立された後、クライアントはメッセージを入力してサーバに送り、そのメッセージはサーバに接続している他の全てのクライアントにも配信されます。


機能要件
サーバは CLI で起動し、バックグラウンドで着信接続を待ち受けます。もしサーバがオフラインであれば、それはチャットサービス自体が停止しているということです。

サーバとクライアントは、UDP ネットワークソケットを使ってメッセージのやり取りをします。
メッセージ送信時、サーバとクライアントは一度に最大で 4096 バイトのメッセージを処理します。これは、クライアントが送信できるメッセージの最大サイズです。同じく、最大 4096 バイトのメッセージが他の全クライアントに転送されます。
セッションが開始される際には、クライアントはユーザーにユーザー名を入力させます。
メッセージの送信プロトコルは比較的シンプルです。メッセージの最初の 1 バイト、usernamelen は、ユーザー名の全バイトサイズを示し、これは最大で 255バイト（28 - 1 バイト）になります。サーバはこの初めの usernamelen バイトを読み、送信者のユーザー名を特定します。その後のバイトは送信される実際のメッセージです。この情報はサーバとクライアントによって自由に使用され、ユーザー名の表示や保存が可能です。
バイトデータは UTF-8 でエンコードおよびデコードされます。これは、1 文字が 1 から 4 バイトで表現される意味です。Python の str.encode と str.decode メソッドは、デフォルトでこの挙動を持っています。
サーバにはリレーシステムが組み込まれており、現在接続中のすべてのクライアントの情報を一時的にメモリ上に保存します。新しいメッセージがサーバに届くと、そのメッセージは現在接続中の全クライアントにリレーされます。
クライアントは、何回か連続で失敗するか、しばらくメッセージを送信していない場合、自動的にリレーシステムから削除されます。この点で TCP と異なり、UDP はコネクションレスであるため、各クライアントの最後のメッセージ送信時刻を追跡する必要があります。
非機能要件
チャットメッセージングシステムは、リアルタイムのデータの優先度が信頼できるデータよりも高いとされています。
システムは、毎秒最低で 10,000 パケットの送信をサポートする必要があります。例えば、1000 人が一つのチャットルームにいる場合、システムは毎秒最低でも 10 メッセージを処理できるように設計されているべきです。一般的なハードウェアならこの条件を満たすことができます。

## 使い方

このリポジトリは UDP ベースのシンプルなチャット（サーバ: `server.py`, クライアント: `client.py`）を含みます。

### 前提
- Python 3.7 以上がインストールされていること
- Windows の場合は PowerShell（pwsh）を想定しています

### ファイル
- `server.py` - 全クライアントへのリレーを行う UDP サーバ
- `client.py` - サーバへメッセージを送信し、サーバからの中継を受信するクライアント

### 起動方法（PowerShell の例）
サーバを起動する（デフォルトでポート 9001 を使用）:

```powershell
python .\server.py
```

クライアントを起動する（起動時にローカルのポートを入力します）:

```powershell
python .\client.py
# プロンプトでローカルのポート番号を指定します（例: 50000）
```

クライアントは起動時にユーザー名を入力します。メッセージをタイプして Enter で送信します。サーバは同じチャットルームの他のクライアントにメッセージを中継します。

### デフォルト設定（ソース内）
- サーバアドレス（送信先）: `127.0.0.1`（`client.py`）
- サーバ受信用ポート: `9001`
- 最大パケットサイズ: 4096 バイト
- クライアントの非アクティブタイムアウト: 300 秒（サーバ側）

### プロトコルの簡単な説明
送信される UDP ペイロードは以下の形式です：
- 最初の 1 バイト: username のバイト長（0〜255）
- 続く usernamelen バイト: UTF-8 エンコードされた username
- 残りのバイト: UTF-8 エンコードされたメッセージ本文

注意:
- username は UTF-8 バイト長で 255 バイト以下にしてください。
- クライアント側では message の長さが 4095 - usernamelen を超えるとエラーになります。

### テストのやり方（同一マシンで複数クライアント）
1. PowerShell を複数開く。
2. 1 つ目のターミナルで `server.py` を実行。
3. 他のターミナルそれぞれで `client.py` を実行し、異なるポート番号とユーザー名を指定する。
4. メッセージを送信して、中継が届くことを確認する。

### トラブルシューティング
- 何も受信できない場合は Windows のファイアウォールやアンチウイルスで Python の通信がブロックされていないか確認してください。
- サーバとクライアントが同じマシンで動いている場合はサーバのアドレスが `127.0.0.1` になっていることを確認してください。
- ポートが既に使われているエラーが出る場合は別のポート番号を指定してください。
- サーバを終了するには Ctrl+C を押してください。

### 追加の改善案（今後）
- クライアント GUI の追加
- 再接続やパケット損失に対する簡易再送ロジック
- ユーザー一覧取得 API、チャットルーム分離