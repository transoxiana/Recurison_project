### 概要

- **目的**: TCP を使ってクライアントから MP4 ファイルをアップロードさせるシンプルなサーバと CLI クライアントを実装するための詳細なコメント設計。実装は Python 推奨。  
- **前提**: ファイルは MP4 のみサポート。送信前にクライアント側で拡張子と MIME を確認すること。ファイルサイズは最大 4GB。パケット送信は 1400 バイト単位で行う。サーバは 32 バイトヘッダ受信後にファイル本体を受け取る。レスポンスは 16 バイトで返す。

### クライアント側設計コメント

- **インポートと初期化**
  - 必要モジュール: `socket`, `argparse`, `os`, `sys`, `logging`, `mimetypes`
  - CLI 引数でサーバアドレス、ポート、アップロードするファイルパスを受け取る

- **事前検証**
  - 指定ファイルが存在するか、読み取り可能かをチェック
  - 拡張子と `mimetypes.guess_type()` で MP4 であることを確認。厳密にはファイルヘッダを少し読み取って MP4 シグネチャを確認しても良い
  - ファイルサイズを取得し `<= MAX_FILE_BYTES` を確認

- **接続と送信プロトコル**
  - TCP ソケットを作成し `connect((server_ip, server_port))`
  - 送信前に 32 バイトヘッダを作成して送信する。ヘッダのフォーマットはサーバと一致させる
  - ファイルは `with open(file, 'rb') as f:` で読み、`while chunk := f.read(CHUNK_SIZE): sock.sendall(chunk)` で送信する
  - `sendall` を使って TCP の全送信を保証する

- **進捗表示とタイムアウト**
  - 送信中に進捗バーや送信済みバイト数を表示する
  - ソケットに適切なタイムアウトを設定し、タイムアウト発生時は再試行や中断をユーザーに通知

- **レスポンス受信**
  - ファイル送信完了後、サーバからの 16 バイトレスポンスを `recv_exact(sock, RESPONSE_SIZE)` で受け取る
  - レスポンスを解析して成功/失敗を表示。失敗時はエラーメッセージを表示

- **再送戦略**
  - 基本は TCP に信頼を委ねるため再送は不要。ただし、送信前にチェックサムを計算してサーバ側で検証するオプションを追加可能
  - 大きなファイルで中断が頻発する環境では、アプリ層でオフセット再開機能を実装することを検討

- **シャットダウンと例外処理**
  - Ctrl+C や例外発生時にソケットを確実に閉じる
  - 送信失敗時は一時ファイルや部分送信のクリーンアップを行う

---

### プロトコル仕様とバイナリフォーマット

- **ヘッダ 32 バイト**
  - **推奨フォーマット例**:
    - bytes 0-7: ファイルサイズを 64 ビット unsigned big-endian
    - bytes 8-15: 将来拡張用フィールド A
    - bytes 16-23: 将来拡張用フィールド B
    - bytes 24-31: チェックサムやフラグ（例: 1 バイトで MP4 フラグ、残りはパディング）
  - ヘッダは固定長で読み取りを行い、未使用領域はゼロで埋める

- **ファイル本体**
  - ヘッダ送信後にファイル本体を連続して送る。送信単位は `CHUNK_SIZE = 1400` バイト
  - 受信側は `file_size` バイトを正確に受け取るまで読み続ける

- **レスポンス 16 バイト**
  - **推奨フォーマット例**:
    - byte 0: ステータスコード（0 = success, 1 = invalid file, 2 = size too large, 3 = storage full, 4 = internal error）
    - bytes 1-3: エラーコード拡張
    - bytes 4-15: UTF-8 の短いメッセージを格納するか、将来拡張用に予約

- **チェックサムオプション**
  - 追加の信頼性として、ヘッダに SHA-256 の先頭数バイトを入れてサーバ側で検証することが可能
  - チェックサムを使う場合はヘッダフォーマットを明確に定義し、クライアントは送信前に計算する

---

### エラーハンドリングとセキュリティ

- **入力検証**
  - ヘッダの `file_size` が 0 または 上限を超える場合は即座にエラー応答
  - ファイル拡張子と MIME タイプの検証を行う

- **原子性**
  - 受信中に失敗した場合は一時ファイルを削除し、部分ファイルが残らないようにする

- **権限とアクセス制御**
  - 保存ディレクトリのパーミッションを最小限に設定し、サーバプロセスのみが書き込み可能にする
  - 公開サーバでは認証や TLS を追加することを推奨するが、ステージ1 では省略可

- **リソース保護**
  - 同時アップロード数、合計ストレージ、1 クライアントあたりの帯域を制限する
  - 悪意あるクライアントによるリソース枯渇を防ぐためにレート制限を実装する

---

### テストと運用メモ

- **単体テスト**
  - `recv_exact` やヘッダパース関数、レスポンス生成関数はユニットテストを用意する
  - 異常系テスト: ヘッダ不正、途中切断、容量不足、非 MP4 ファイル送信

- **統合テスト**
  - ローカルでサーバを起動し、複数クライアントから同時にアップロードして動作確認
  - 大きなファイル（数百 MB）での送受信テストを行い、タイムアウトやメモリ使用量を監視

- **運用**
  - サーバは systemd や Windows サービスで常駐させる
  - ログローテーションとディスク使用量監視を設定する
  - 将来的に TLS、認証、ジョブキュー、FFMPEG 連携などを追加可能

